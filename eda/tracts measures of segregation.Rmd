---
title: "Measures of Segregation"
author: 
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)
library(tidycensus)




# Parameters

file_race_ethnicity_tracts <- "../data/appalachian_tracts_race.csv"
file_central_race_ethnicity_tracts <-
  "../data/central_appalachian_tracts_race.csv"

file_race_ethnicity_counties <- 
  "../data/appalachian_counties_race.csv"

file_out <-
  "../data/appalachian_counties_segregation_indices.csv"
file_out_pivoted <- 
  "../data/appalachian_counties_segregation_indices_pivoted.csv"

#===============================================================================

# Code
```

Notes on this document: See also, "blocks measures of segregation," which performs similar analysis but using block-level data from the 2010 decennial census. 


This [study](https://www.census.gov/prod/2002pubs/censr-3.pdf) from the census bureau uses tracts as the unit of analysis for measuring segregation. 

To quantify segregation, they use the following measures (Massey, 1988)

* Evenness: the differential distribution of the subject population (dissimilarity index)
* Exposure: measures potential contact (isolation index)
* Concentration: the relative amount of physical space occupied (delta index)
* Centralization: degree to which a group is located near the center of an urban area (absolute centralization index)
* Clustering: the degree to which minority group members live disproportionately in contiguous areas (spatial proximity index)

Their analysis focused only on metropolitan statistical areas. This other [study](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5285374/) focused on rural areas used the isolation index. 


```{r}
race_ethnicity_tracts <- 
  file_race_ethnicity_tracts %>%
  read_csv(
    col_types = 
      cols(
        fips = col_character(),
        name = col_character(),
        prop_nonwhite = col_double(),
        .default = col_integer()
      )
  )

race_ethnicity_counties <- 
  file_race_ethnicity_counties %>%
  read_csv(
    col_types = 
      cols(
        county_name = col_character(),
        state_name = col_character(),
        .default = col_integer()
      )
  )
```

Calculate isolation index for African American population:

Isolation index [source](https://ignaciomsarmiento.github.io/2017/03/24/Mapping-Segregation-in-Chicago.html) = 

\( \frac{
  \sum_{i=1}^n \left( \frac{AA_i}{AA_{total}} \cdot \frac{AA_i}{persions_i} \right) 
  - \frac{AA_{total}}{persons_{total}}}{1 - \frac{AA_{total}}{persons_{total}}} \) 
  
Where \(AA_i\) is the number of African Americans in tract i; \(AA_{total}\) is the number of African Americans in the county as a whole; \(persons_i\) denotes total population in tract i.


```{r}
# for an index to be counted, 
# counties must contain at least one census tract with prop of population of 
# interest > prop, or must have a total prop of population > prop 
  prop <- 0.05

# filter to counties with at least one tract > prop AA population
counties <- 
  c(
    race_ethnicity_tracts %>%
      filter(black / total_population > prop) %>%
      pull(county_fips),
    race_ethnicity_counties %>%
      filter(black / total_population > prop) %>%
      pull(fips)
  ) %>%
  unique()
  
race_counties_aa_isolation_index <- 
  race_ethnicity_tracts %>%
  select(county_fips, name, persons_i = total_population, aa_i = black) %>%
  filter(county_fips %in% counties, persons_i > 0) %>%
  group_by(county_fips) %>%
  summarize(
    aa_total = sum(aa_i),
    pop_total = sum(persons_i),
    prop_aa_county = aa_total / pop_total,
    numerator_1 = sum((aa_i / aa_total) * (aa_i / persons_i))
  ) %>%
  mutate(
    aa_isolation_index = (numerator_1 - prop_aa_county) / (1 - prop_aa_county)
  ) %>% 
  select(county_fips, aa_isolation_index)

# filter to counties with at least one tract > prop Hispanic/Latino population
counties <- 
  race_ethnicity_tracts %>%
  filter(hispanic_latino / total_population > 0.05) %>%
  pull(county_fips) %>%
  unique()

race_counties_hisp_isolation_index <- 
  race_ethnicity_tracts %>%
  select(
    county_fips, 
    name, 
    persons_i = total_population, 
    hl_i = hispanic_latino
  ) %>%
  filter(county_fips %in% counties, persons_i > 0) %>%
  group_by(county_fips) %>%
  summarize(
    hl_total = sum(hl_i),
    pop_total = sum(persons_i),
    prop_hl_county = hl_total / pop_total,
    numerator_1 = sum((hl_i / hl_total) * (hl_i / persons_i))
  ) %>%
  mutate(
    hl_isolation_index = (numerator_1 - prop_hl_county) / (1 - prop_hl_county)
  ) %>% 
  select(county_fips, hl_isolation_index)

# filter to counties with at least one tract > prop native am. population
counties <- 
  race_ethnicity_tracts %>%
  filter(american_indian_alaska_native / total_population > 0.05) %>%
  pull(county_fips) %>%
  unique()

race_counties_na_isolation_index <- 
  race_ethnicity_tracts %>%
  select(
    county_fips, 
    name, 
    persons_i = total_population, 
    na_i = american_indian_alaska_native
  ) %>%
  filter(county_fips %in% counties, persons_i > 0) %>%
  group_by(county_fips) %>%
  summarize(
    na_total = sum(na_i),
    pop_total = sum(persons_i),
    prop_na_county = na_total / pop_total,
    numerator_1 = sum((na_i / na_total) * (na_i / persons_i))
  ) %>%
  mutate(
    na_isolation_index = (numerator_1 - prop_na_county) / (1 - prop_na_county)
  ) %>% 
  select(county_fips, na_isolation_index)

race_counties_isolation_indices <- 
  list(
    race_ethnicity_counties %>% rename(county_fips = fips),
    race_counties_aa_isolation_index,
    race_counties_hisp_isolation_index, 
    race_counties_na_isolation_index
  ) %>%
  reduce(left_join, by = "county_fips")
```

Isolation indices range from 0 to 1, where values closer to 1 indicate higher levels of segregation. 

```{r}
race_counties_isolation_indices %>%
  select(aa_isolation_index, hl_isolation_index, na_isolation_index) %>%
  summary()

plot_isolation_index <- function(tibble, group) {
  tibble %>% 
    drop_na() %>%
    filter(prop_race > 0) %>%
    ggplot(aes(is_index, prop_race)) + 
    geom_point() +
    scale_x_continuous(limits = c(0, 0.47)) +
    labs(
      title = str_glue(group, " Population & Isolation Index: Appalachia"),
      x = "Isolation Index (1 = more residential segregation)",
      y = str_glue("Prop. of county pop self-identified as ", group),
      caption = "Source: American Community Survey, 2018"
    )
}
  
plot_isolation_index(
  race_counties_isolation_indices %>% 
    transmute(
      is_index = aa_isolation_index, 
      prop_race = black / total_population
    ),
  "African American"
)

plot_isolation_index(
  race_counties_isolation_indices %>% 
    transmute(
      is_index = hl_isolation_index, 
      prop_race = hispanic_latino / total_population
    ),
  "Hispanic & Latino"
)

plot_isolation_index(
  race_counties_isolation_indices %>% 
    transmute(
      is_index = na_isolation_index, 
      prop_race = american_indian_alaska_native / total_population
    ),
  "Native American"
)



```




Dissimilarity index:

"If African Americans disproportionately reside in some areas of a county relative to non-African Americans, we say that dissimilarity between the two races is high."

\( \frac{1}{2} \sum_{i=1}^N \mid {\frac{AA_i}{AA_{total}} - \frac{AA_i^c}{AA_{total}^c}} \mid \)

Same notation as above, and \(AA_i^c\) is the number of non African Americans in tract i, and \(AA_{total}^c\) is the number of non African Americans in the city.

```{r}
# filter to counties with at least one tract > prop AA population
counties <- 
  c(
    race_ethnicity_tracts %>%
      filter(black / total_population > prop) %>%
      pull(county_fips),
    race_ethnicity_counties %>%
      filter(black / total_population > prop) %>%
      pull(fips)
  ) %>%
  unique()

aa_counties_dissimilarity_index <- 
  race_ethnicity_tracts %>%
  select(
    county_fips, 
    name, 
    persons_i = total_population, 
    aa_i = black
  ) %>%
  filter(county_fips %in% counties) %>%
  group_by(county_fips) %>%
  summarize(
    aa_total = sum(aa_i),
    aa_c_total = sum(persons_i) - sum(aa_i),
    aa_dissimilarity_index = 
      0.5*sum(abs(aa_i / aa_total - (persons_i - aa_i) / aa_c_total))
  ) %>% 
  select(county_fips, aa_dissimilarity_index)

# filter to counties with at least one tract > prop HL population
counties <- 
  c(
    race_ethnicity_tracts %>%
      filter(hispanic_latino / total_population > prop) %>%
      pull(county_fips),
    race_ethnicity_counties %>%
      filter(hispanic_latino / total_population > prop) %>%
      pull(fips)
  ) %>%
  unique()

hl_counties_dissimilarity_index <- 
  race_ethnicity_tracts %>%
  select(
    county_fips, 
    name, 
    persons_i = total_population, 
    hl_i = hispanic_latino
  ) %>%
  filter(county_fips %in% counties) %>%
  group_by(county_fips) %>%
  summarize(
    hl_total = sum(hl_i),
    hl_c_total = sum(persons_i) - sum(hl_i),
    hl_dissimilarity_index = 
      0.5*sum(abs(hl_i / hl_total - (persons_i - hl_i) / hl_c_total))
  ) %>% 
  select(county_fips, hl_dissimilarity_index)

# filter to counties with at least one tract > prop NA population
counties <- 
  c(
    race_ethnicity_tracts %>%
      filter(american_indian_alaska_native / total_population > prop) %>%
      pull(county_fips),
    race_ethnicity_counties %>%
      filter(american_indian_alaska_native / total_population > prop) %>%
      pull(fips)
  ) %>%
  unique()

na_counties_dissimilarity_index <- 
  race_ethnicity_tracts %>%
  select(
    county_fips, 
    name, 
    persons_i = total_population, 
    na_i = american_indian_alaska_native
  ) %>%
  filter(county_fips %in% counties) %>%
  group_by(county_fips) %>%
  summarize(
    na_total = sum(na_i),
    na_c_total = sum(persons_i) - sum(na_i),
    na_dissimilarity_index = 
      0.5*sum(abs(na_i / na_total - (persons_i - na_i) / na_c_total))
  ) %>% 
  select(county_fips, na_dissimilarity_index)

race_counties_dissimilarity_indices <- 
  list(
    race_ethnicity_counties %>% rename(county_fips = fips),
    aa_counties_dissimilarity_index,
    hl_counties_dissimilarity_index, 
    na_counties_dissimilarity_index
  ) %>%
  reduce(left_join, by = "county_fips")

```

```{r}
race_counties_dissimilarity_indices %>%
  select(
    aa_dissimilarity_index, 
    hl_dissimilarity_index, 
    na_dissimilarity_index
  ) %>%
  summary()

```


```{r}
race_ethnicity_tracts %>%
  filter(
    county_fips %in% 
    (race_counties_dissimilarity_indices %>%
      filter(na_dissimilarity_index < 0.3) %>%
      pull(county_fips))
  ) %>%
  select(county_fips, name, total_population, american_indian_alaska_native)
```



```{r}
race_counties_segregation_indices <- 
  race_counties_dissimilarity_indices %>%
  left_join(
    race_counties_isolation_indices %>% 
      select(
        county_fips, 
        aa_isolation_index, 
        hl_isolation_index, 
        na_isolation_index
      ), 
    by = "county_fips"
  )
```


```{r}
counties_segregation_geo <- 
  race_counties_segregation_indices %>%
  left_join(
    ussf::boundaries(geography = "county") %>%
      transmute(county_fips = as.integer(GEOID), geometry),
    by = "county_fips"
  )
  

plot_segregation <- function(tibble, group, index) {
  tibble %>%
    ggplot(aes(geometry = geometry, fill = index)) + 
    geom_sf() + 
    scale_fill_viridis_c() +
    theme_void() + 
    labs(
      title = str_glue(index, " of ", group, " Population"),
      subtitle = 
        str_glue("Counties with at least one census tract having ", 
                 prop*100,
                 "% or more\n",
                 group, 
                 " population, or with overall\n", 
                 group, 
                 " population at least ", 
                 prop*100, 
                 "%."
                )
    )
}

plot_segregation(
  counties_segregation_geo %>% 
    select(
      index = aa_dissimilarity_index,
      geometry
    ),
  group = "African American",
  index = "Dissimilarity Index"
)

plot_segregation(
  counties_segregation_geo %>% 
    select(
      index = hl_dissimilarity_index,
      geometry
    ),
  group = "Hispanic/Latinx",
  index = "Dissimilarity Index"
)
  
plot_segregation(
  counties_segregation_geo %>% 
    select(
      index = na_dissimilarity_index,
      geometry
    ),
  group = "American Indian/Alaska Native",
  index = "Dissimilarity Index"
)

plot_segregation(
  counties_segregation_geo %>% 
    select(
      index = aa_isolation_index,
      geometry
    ),
  group = "African American",
  index = "Isolation Index"
)

plot_segregation(
  counties_segregation_geo %>% 
    select(
      index = hl_isolation_index,
      geometry
    ),
  group = "Hispanic/Latinx",
  index = "Isolation Index"
)
  
plot_segregation(
  counties_segregation_geo %>% 
    select(
      index = na_isolation_index,
      geometry
    ),
  group = "American Indian/Alaska Native",
  index = "Isolation Index"
)


```


```{r}
segregation_indices_pivoted <- 
  race_counties_segregation_indices %>%
  select(
    county_fips,
    county_name,
    state_name,
    total_population,
    hispanic_latino,
    black,
    american_indian_alaska_native,
    isolation_black = aa_isolation_index,
    isolation_hisplatino = hl_isolation_index,
    isolation_nativeam = na_isolation_index,
    dissimilarity_black = aa_dissimilarity_index,
    dissimilarity_hisplatino = hl_dissimilarity_index,
    dissimilarity_nativeam = na_dissimilarity_index
  ) %>%
  pivot_longer(
    cols = isolation_black:dissimilarity_nativeam,
    names_to = c("index_name", "race_ethn"),
    names_sep = "_",
    values_to = "index_value"
  ) %>%
  drop_na() %>%
  mutate(
    pop_group = 
      case_when(
        race_ethn == "black" ~ black,
        race_ethn == "nativeam" ~ american_indian_alaska_native,
        race_ethn == "hisplatino" ~ hispanic_latino
      ),
    prop_of_population = pop_group / total_population
  )


segregation_indices_pivoted %>%
  ggplot(aes(index_value, color = index_name)) +
  geom_density() +
  facet_grid(cols = vars(race_ethn))

segregation_indices_pivoted %>%
  ggplot(aes(index_value, color = fct_reorder(race_ethn,index_value))) +
  geom_density() +
  facet_grid(cols = vars(index_name)) +
  scale_color_discrete(
    breaks = c("hisplatino", "nativeam", "black"),
    labels = 
      c(
        "Hispanic/\nLatinx", 
        "American Indian/\nAlaska Native", 
        "African American"
      )
  ) + 
  theme(legend.position = "top") +
  labs(
    x = "Index Value (1 indicated higher segregation)",
    y = "Density (Number of Counties)",
    color = ""
  )
```


```{r}
segregation_indices_pivoted %>%
  sample_frac() %>%
  ggplot(aes(index_value, total_population, color = race_ethn)) +
  geom_point(alpha = 0.8) +
  facet_grid(cols = vars(index_name)) +
  scale_color_discrete(
    breaks = c("hisplatino", "nativeam", "black"),
    labels = 
      c(
        "Hispanic/\nLatinx", 
        "American Indian/\nAlaska Native", 
        "African American"
      )
  ) + 
  theme(legend.position = "top") +
  labs(
    x = "Index Value (1 indicated higher segregation)",
    y = "Total Population of the County",
    color = ""
  )
```


```{r}
segregation_indices_pivoted %>%
  sample_frac() %>%
  ggplot(aes(index_value, prop_of_population, color = race_ethn)) +
  geom_point(alpha = 0.8) +
  facet_grid(cols = vars(index_name)) +
  scale_color_discrete(
    breaks = c("hisplatino", "nativeam", "black"),
    labels = 
      c(
        "Hispanic/\nLatinx", 
        "American Indian/\nAlaska Native", 
        "African American"
      )
  ) + 
  theme(legend.position = "top") +
  labs(
    x = "Index Value (1 indicated higher segregation)",
    y = "Group's Proportion of County Population",
    color = ""
  )
```

```{r, fig.asp=1}
segregation_indices_pivoted %>%
  filter(race_ethn == "black") %>%
  ggplot(aes(index_value, color = index_name)) + 
  geom_density() +
  facet_wrap(vars(state_name)) +
  theme(legend.position = "top") +
  labs(title = "Af. Am population")

segregation_indices_pivoted %>%
  filter(race_ethn == "hisplatino", state_name != "Maryland") %>%
  ggplot(aes(index_value, color = index_name)) + 
  geom_density() +
  facet_wrap(vars(state_name)) +
  theme(legend.position = "top") +
  labs(title = "Hisp/Latinx population")
```


```{r}
race_counties_segregation_indices %>% write_csv(file_out)
  
segregation_indices_pivoted %>% write_csv(file_out_pivoted)

```















